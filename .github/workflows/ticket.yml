name: V√©rification de la pr√©sence d'une issue et association au projet

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    steps:
      - name: Installer GitHub CLI et jq
        run: sudo apt-get update && sudo apt-get install gh jq -y

      - name: V√©rifier la r√©f√©rence √† une issue et l'association au projet
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          BRANCHE="${{ github.head_ref }}"
          TITRE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"
          PROJECT_NUMBER=19

          echo "Nom de branche : $BRANCHE"
          echo "Titre de PR : $TITRE"

          # Extraire le num√©ro de l'issue
          ISSUE_NUMBER=$(echo "$TITRE" | grep -o '#[0-9]\+' | tr -d '#')
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$BRANCHE" | grep -o '[0-9]\+')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå Aucune r√©f√©rence √† une issue d√©tect√©e"
            echo "üí° Ajouter #<num√©ro> dans le titre ou le nom de la branche"
            exit 1
          fi

          echo "Num√©ro d'issue d√©tect√© : $ISSUE_NUMBER"

          # V√©rifier si l'issue existe
          if ! gh api repos/$REPO/issues/$ISSUE_NUMBER >/dev/null 2>&1; then
            echo "‚ùå L'issue #$ISSUE_NUMBER n'existe pas dans le repo $REPO"
            exit 1
          fi

          # V√©rifier association au projet GitHub (Projects v2)
          ISSUE_URL="https://github.com/${REPO}/issues/${ISSUE_NUMBER}"

          # R√©cup√©rer les colonnes du projet
          COLUMNS=$(gh api projects/$PROJECT_NUMBER/columns \
            -H "Accept: application/vnd.github.inertia-preview+json" \
            -q '.[].id')

          ISSUE_FOUND=false
          for col_id in $COLUMNS; do
              CARDS=$(gh api projects/columns/$col_id/cards \
                  -H "Accept: application/vnd.github.inertia-preview+json")
              if echo "$CARDS" | jq -r '.[].content_url' | grep -q "$ISSUE_URL"; then
                  ISSUE_FOUND=true
                  break
              fi
          done

          if [ "$ISSUE_FOUND" = true ]; then
            echo "‚úÖ L'issue #$ISSUE_NUMBER est associ√©e au projet GitHub $PROJECT_NUMBER"
          else
            echo "‚ùå L'issue #$ISSUE_NUMBER n'est pas associ√©e au projet GitHub $PROJECT_NUMBER"
            echo "üí° Associez l‚Äôissue au projet : https://github.com/users/RustyRory/projects/19"
            exit 1
          fi
