name: V√©rification de la pr√©sence d'une issue

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    steps:
      - name: Installer GitHub CLI
        run: sudo apt-get update && sudo apt-get install gh -y

      - name: V√©rifier la r√©f√©rence √† une issue
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          BRANCHE="${{ github.head_ref }}"
          TITRE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"

          echo "Nom de branche : $BRANCHE"
          echo "Titre de PR : $TITRE"

          # Extraire le num√©ro de l'issue depuis le titre ou la branche
          ISSUE_NUMBER=$(echo "$TITRE" | grep -o '#[0-9]\+' | tr -d '#')
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$BRANCHE" | grep -o '[0-9]\+')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå Aucune r√©f√©rence √† une issue d√©tect√©e"
            echo "üí° Ajouter #<num√©ro> dans le titre de la PR ou inclure le num√©ro dans le nom de la branche"
            exit 1
          fi

          echo "Num√©ro d'issue d√©tect√© : $ISSUE_NUMBER"

          # V√©rifier si l'issue existe dans le repo
          if ! gh api repos/$REPO/issues/$ISSUE_NUMBER >/dev/null 2>&1; then
            echo "‚ùå L'issue #$ISSUE_NUMBER n'existe pas dans le repo $REPO"
            exit 1
          fi

          echo "‚úÖ L'issue #$ISSUE_NUMBER est correctement r√©f√©renc√©e et existe dans le repo"
