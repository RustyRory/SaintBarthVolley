name: V√©rification de la pr√©sence d'une issue

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    steps:
      - name: Installer GitHub CLI
        run: sudo apt-get update && sudo apt-get install gh jq -y

      - name: V√©rifier la r√©f√©rence √† une issue et l'association au projet
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCHE="${{ github.head_ref }}"
          TITRE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"

          echo "Nom de branche : $BRANCHE"
          echo "Titre de PR : $TITRE"

          # Extraire le num√©ro de l'issue
          ISSUE_NUMBER=$(echo "$TITRE" | grep -o '#[0-9]\+' | tr -d '#')
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$BRANCHE" | grep -o '[0-9]\+')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå Aucune r√©f√©rence √† une issue d√©tect√©e"
            echo "üí° Ajouter #<num√©ro> dans le titre ou le nom de la branche"
            exit 1
          fi

          echo "Num√©ro d'issue d√©tect√© : $ISSUE_NUMBER"

          # V√©rifier si l'issue est associ√©e au projet GitHub (ID du projet)
          TARGET_PROJECT_ID=19

          # R√©cup√©rer les projets li√©s √† l'issue via l'API GitHub
          ISSUE_PROJECTS=$(gh api repos/$REPO/issues/$ISSUE_NUMBER/projects \
            -H "Accept: application/vnd.github.inertia-preview+json" \
            -q '.[].id')

          if echo "$ISSUE_PROJECTS" | grep -q "$TARGET_PROJECT_ID"; then
            echo "‚úÖ L'issue #$ISSUE_NUMBER est associ√©e au projet $TARGET_PROJECT_ID"
          else
            echo "‚ùå L'issue #$ISSUE_NUMBER n'est pas associ√©e au projet $TARGET_PROJECT_ID"
            echo "üí° Associez l‚Äôissue au projet GitHub : https://github.com/users/RustyRory/projects/19"
            exit 1
          fi
