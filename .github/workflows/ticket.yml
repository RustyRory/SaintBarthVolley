name: V√©rification de la pr√©sence d'une issue et association au projet

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    steps:
      - name: Installer GitHub CLI et jq
        run: sudo apt-get update && sudo apt-get install gh jq -y

      - name: V√©rifier la r√©f√©rence √† une issue et l'association au projet
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCHE="${{ github.head_ref }}"
          TITRE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"

          echo "Nom de branche : $BRANCHE"
          echo "Titre de PR : $TITRE"

          # Extraire le num√©ro de l'issue
          ISSUE_NUMBER=$(echo "$TITRE" | grep -o '#[0-9]\+' | tr -d '#')
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$BRANCHE" | grep -o '[0-9]\+')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå Aucune r√©f√©rence √† une issue d√©tect√©e"
            exit 1
          fi

          echo "Num√©ro d'issue d√©tect√© : $ISSUE_NUMBER"

          # V√©rifier si l'issue est associ√©e au projet GitHub Projects v2
          PROJECT_NUMBER=19
          ISSUE_URL="https://github.com/${REPO}/issues/${ISSUE_NUMBER}"

          ITEMS=$(gh project view $PROJECT_NUMBER --json items --jq '.items[].content.url')

          if echo "$ITEMS" | grep -q "$ISSUE_URL"; then
            echo "‚úÖ L'issue #$ISSUE_NUMBER est associ√©e au projet $PROJECT_NUMBER"
          else
            echo "‚ùå L'issue #$ISSUE_NUMBER n'est pas associ√©e au projet $PROJECT_NUMBER"
            echo "üí° Associez l‚Äôissue au projet GitHub : https://github.com/users/RustyRory/projects/19"
            exit 1
          fi
